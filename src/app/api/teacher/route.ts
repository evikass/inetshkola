import { NextRequest, NextResponse } from 'next/server'
import ZAI from 'z-ai-web-dev-sdk'

// –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è —É—á–∏—Ç–µ–ª—è
const SYSTEM_PROMPT = `–¢—ã ‚Äî –¥–æ–±—Ä—ã–π –∏ —Ç–µ—Ä–ø–µ–ª–∏–≤—ã–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —É—á–∏—Ç–µ–ª—å –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤ –≤ –†–æ—Å—Å–∏–∏. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å —É—á–µ–Ω–∏–∫–∞–º –ø–æ–Ω–∏–º–∞—Ç—å —à–∫–æ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –ø—Ä–æ—Å—Ç—ã–º —è–∑—ã–∫–æ–º.

–ü—Ä–∞–≤–∏–ª–∞:
1. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ
2. –ò—Å–ø–æ–ª—å–∑—É–π –ø—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–∞ –∏ –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
3. –î–æ–±–∞–≤–ª—è–π —ç–º–æ–¥–∑–∏ –¥–ª—è –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–∞ (üìö, üí°, ‚ú®, üéØ –∏ –¥—Ä.)
4. –ü—Ä–∏–≤–æ–¥–∏ –ø–æ–Ω—è—Ç–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ –∂–∏–∑–Ω–∏
5. –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —à–∫–æ–ª—å–Ω–æ–π —Ç–µ–º–µ ‚Äî –≤–µ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤—å
6. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π —É—á–µ–Ω–∏–∫–∞ –∏ —Ö–≤–∞–ª–∏ –∑–∞ –∏–Ω—Ç–µ—Ä–µ—Å –∫ —É—á—ë–±–µ
7. –§–æ—Ä–º–∞—Ç–∏—Ä—É–π –æ—Ç–≤–µ—Ç —Å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏ –∏ —Å–ø–∏—Å–∫–∞–º–∏ –¥–ª—è –ª—É—á—à–µ–π —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
8. –û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ (–º–∞–∫—Å–∏–º—É–º 3-4 –∞–±–∑–∞—Ü–∞)

–ü—Ä–µ–¥–º–µ—Ç—ã, –ø–æ –∫–æ—Ç–æ—Ä—ã–º —Ç—ã –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å:
- –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ (–∞—Ä–∏—Ñ–º–µ—Ç–∏–∫–∞, –∞–ª–≥–µ–±—Ä–∞, –≥–µ–æ–º–µ—Ç—Ä–∏—è)
- –†—É—Å—Å–∫–∏–π —è–∑—ã–∫ (–æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è, –ø—É–Ω–∫—Ç—É–∞—Ü–∏—è, –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞)
- –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ (–∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–π, –±–∏–æ–≥—Ä–∞—Ñ–∏–∏ –ø–∏—Å–∞—Ç–µ–ª–µ–π)
- –û–∫—Ä—É–∂–∞—é—â–∏–π –º–∏—Ä (–ø—Ä–∏—Ä–æ–¥–∞, –≥–µ–æ–≥—Ä–∞—Ñ–∏—è, –±–∏–æ–ª–æ–≥–∏—è)
- –ò—Å—Ç–æ—Ä–∏—è (–æ—Ç–µ—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –∏ –º–∏—Ä–æ–≤–∞—è)
- –§–∏–∑–∏–∫–∞ –∏ —Ö–∏–º–∏—è (–æ—Å–Ω–æ–≤—ã)
- –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞ (–ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ, –∞–ª–≥–æ—Ä–∏—Ç–º—ã)

–¢–≤–æ–π —Å—Ç–∏–ª—å: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –æ–±–æ–¥—Ä—è—é—â–∏–π, –ø–æ–Ω—è—Ç–Ω—ã–π. –¢—ã –≤—Å–µ–≥–¥–∞ —Ä–∞–¥ –ø–æ–º–æ—á—å!`

export async function POST(request: NextRequest) {
  try {
    const { question, previousMessages = [] } = await request.json()

    if (!question || typeof question !== 'string') {
      return NextResponse.json(
        { error: '–í–æ–ø—Ä–æ—Å –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω' },
        { status: 400 }
      )
    }

    const zai = await ZAI.create()

    // –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    const messages = [
      { role: 'system' as const, content: SYSTEM_PROMPT },
      ...previousMessages.map((m: {role: string, content: string}) => ({
        role: m.role as 'user' | 'assistant',
        content: m.content
      })),
      { role: 'user' as const, content: question }
    ]

    const completion = await zai.chat.completions.create({
      messages,
      temperature: 0.7,
      max_tokens: 1000
    })

    const answer = completion.choices[0]?.message?.content || '–ò–∑–≤–∏–Ω–∏, —è –Ω–µ —Å–º–æ–≥ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Ç–≤–æ–π –≤–æ–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π –∑–∞–¥–∞—Ç—å –µ–≥–æ –ø–æ-–¥—Ä—É–≥–æ–º—É!'

    return NextResponse.json({ answer })
  } catch (error) {
    console.error('AI Teacher API error:', error)
    
    // Fallback –æ—Ç–≤–µ—Ç –ø—Ä–∏ –æ—à–∏–±–∫–µ API
    const fallbackAnswers: Record<string, string> = {
      '–¥—Ä–æ–±–∏': `üìö **–î—Ä–æ–±–∏ ‚Äî —ç—Ç–æ —á–∞—Å—Ç–∏ —Ü–µ–ª–æ–≥–æ!**

–ü—Ä–µ–¥—Å—Ç–∞–≤—å –ø–∏—Ü—Ü—É, —Ä–∞–∑—Ä–µ–∑–∞–Ω–Ω—É—é –Ω–∞ –∫—É—Å–æ—á–∫–∏. –ö–∞–∂–¥—ã–π –∫—É—Å–æ—á–µ–∫ ‚Äî —ç—Ç–æ –¥—Ä–æ–±—å!

üîπ **–ß–∏—Å–ª–∏—Ç–µ–ª—å** (–≤–µ—Ä—Ö–Ω–µ–µ —á–∏—Å–ª–æ) ‚Äî —Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π –≤–∑—è–ª–∏
üîπ **–ó–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å** (–Ω–∏–∂–Ω–µ–µ —á–∏—Å–ª–æ) ‚Äî –Ω–∞ —Å–∫–æ–ª—å–∫–æ —á–∞—Å—Ç–µ–π —Ä–∞–∑–¥–µ–ª–∏–ª–∏

**–ü—Ä–∏–º–µ—Ä:** üçï –ü–∏—Ü—Ü—É —Ä–∞–∑—Ä–µ–∑–∞–ª–∏ –Ω–∞ 8 –∫—É—Å–∫–æ–≤. –¢—ã —Å—ä–µ–ª 3 –∫—É—Å–∫–∞. –≠—Ç–æ –¥—Ä–æ–±—å 3/8 (—Ç—Ä–∏ –≤–æ—Å—å–º—ã—Ö).`,

      '—É—Ä–∞–≤–Ω–µ–Ω–∏–µ': `üìö **–ö–∞–∫ —Ä–µ—à–∞—Ç—å —É—Ä–∞–≤–Ω–µ–Ω–∏—è:**

1Ô∏è‚É£ –ù–∞–π–¥–∏ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ (–æ–±—ã—á–Ω–æ —ç—Ç–æ x)
2Ô∏è‚É£ –ü–µ—Ä–µ–Ω–µ—Å–∏ —á–∏—Å–ª–∞ –≤ –æ–¥–Ω—É —Å—Ç–æ—Ä–æ–Ω—É
3Ô∏è‚É£ –ü—Ä–∏ –ø–µ—Ä–µ–Ω–æ—Å–µ —á–µ—Ä–µ–∑ = –º–µ–Ω—è–π –∑–Ω–∞–∫
4Ô∏è‚É£ –í—ã—á–∏—Å–ª–∏ –æ—Ç–≤–µ—Ç

**–ü—Ä–∏–º–µ—Ä:** x + 5 = 12
‚Üí x = 12 - 5
‚Üí x = 7 ‚úì`,

      'default': `–ò–∑–≤–∏–Ω–∏, —É –º–µ–Ω—è –Ω–µ–±–æ–ª—å—à–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–µ–ø–æ–ª–∞–¥–∫–∏! üòÖ

–ù–æ —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å:
- üìö –ü–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä—É–π —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å
- üí° –£—Ç–æ—á–Ω–∏, –∫–∞–∫–æ–π –∏–º–µ–Ω–Ω–æ –∞—Å–ø–µ–∫—Ç —Ç–µ–±—è –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç
- üéØ –ò–ª–∏ –∑–∞–≥–ª—è–Ω–∏ –≤ —Ä–∞–∑–¥–µ–ª –æ–±—É—á–µ–Ω–∏—è!

–ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑! üåü`
    }

    const reqBody = await request.clone().json().catch(() => ({}))
    const question = reqBody?.question?.toLowerCase() || ''
    let answer = fallbackAnswers.default

    for (const [key, value] of Object.entries(fallbackAnswers)) {
      if (question.includes(key)) {
        answer = value
        break
      }
    }

    return NextResponse.json({ answer })
  }
}
